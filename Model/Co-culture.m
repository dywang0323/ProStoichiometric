clear; clc
data=[0.12	0.13	0.14	0.05	0.06	0.06	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.07	0.07	0.07	0.18	0.20	0.21
0.13	0.13	0.13	0.05	0.05	0.06	0.00	0.00	0.00	0.04	0.04	0.00	0.03	0.03	0.03	0.09	0.09	0.09	0.21	0.23	0.23
0.36	0.31	0.35	0.19	0.17	0.19	0.00	0.00	0.00	0.14	0.14	0.12	0.08	0.07	0.07	0.18	0.19	0.18	0.58	0.57	0.61
0.52	0.51	0.53	0.33	0.32	0.33	0.00	0.00	0.00	0.17	0.16	0.17	0.12	0.12	0.12	0.29	0.28	0.30	0.94	0.99	1.01
0.84	0.77	0.83	0.51	0.49	0.53	0.00	0.00	0.00	0.20	0.20	0.19	0.17	0.17	0.17	0.45	0.43	0.45	1.45	1.48	1.56
1.17	1.12	1.16	0.82	0.83	0.83	0.00	0.00	0.00	0.23	0.25	0.06	0.23	0.23	0.22	0.61	0.62	0.62	2.10	2.24	2.24
1.37	1.34	1.37	0.97	0.97	0.99	0.00	0.00	0.00	0.26	0.23	0.22	0.27	0.27	0.27	0.78	0.78	0.78	2.50	2.68	2.69
0.12	0.12	0.11	0.08	0.07	0.07	0.07	0.07	0.07	0.00	0.00	0.00	0.00	0.00	0.00	0.07	0.07	0.07	0.22	0.19	0.21
0.18	0.17	0.20	0.11	0.11	0.11	0.08	0.08	0.08	0.00	0.00	0.00	0.05	0.04	0.05	0.09	0.08	0.08	0.33	0.30	0.36
0.41	0.37	0.41	0.23	0.21	0.22	0.09	0.14	0.09	0.00	0.01	0.00	0.08	0.09	0.08	0.17	0.16	0.16	0.70	0.60	0.70
0.50	0.51	0.52	0.31	0.32	0.34	0.11	0.12	0.11	0.13	0.13	0.14	0.12	0.11	0.11	0.24	0.25	0.22	0.93	0.87	0.98
0.84	0.79	0.78	0.51	0.52	0.53	0.13	0.14	0.14	0.15	0.15	0.16	0.16	0.17	0.16	0.35	0.36	0.37	1.49	1.35	1.50
1.22	1.25	1.24	0.83	0.85	0.83	0.15	0.16	0.16	0.17	0.16	0.16	0.25	0.21	0.23	0.53	0.51	0.50	2.26	2.07	2.29
1.50	1.45	1.46	1.08	1.05	1.11	0.17	0.18	0.18	0.20	0.22	0.22	0.29	0.29	0.29	0.50	0.47	0.48	2.76	2.45	2.80
0.13	0.14	0.13	0.04	0.05	0.05	0.08	0.08	0.08	0.00	0.00	0.00	0.00	0.00	0.00	0.07	0.07	0.08	0.15	0.17	0.17
0.16	0.16	0.16	0.05	0.06	0.05	0.09	0.09	0.10	0.00	0.00	0.00	0.04	0.04	0.04	0.09	0.09	0.09	0.23	0.22	0.24
0.30	0.32	0.34	0.23	0.22	0.22	0.17	0.16	0.16	0.02	0.02	0.02	0.07	0.07	0.07	0.19	0.20	0.17	0.60	0.58	0.58
0.44	0.43	0.43	0.28	0.30	0.31	0.20	0.22	0.22	0.13	0.13	0.13	0.10	0.10	0.10	0.29	0.29	0.29	0.85	0.84	0.92
0.71	0.72	0.72	0.44	0.41	0.42	0.28	0.29	0.28	0.16	0.17	0.18	0.15	0.16	0.15	0.46	0.46	0.46	1.29	1.22	1.33
0.99	1.00	0.98	0.83	0.83	0.81	0.36	0.36	0.36	0.18	0.20	0.21	0.23	0.23	0.23	0.66	0.70	0.68	2.07	2.03	2.14
1.25	1.24	1.22	1.02	1.00	0.96	0.41	0.42	0.41	0.22	0.23	0.25	0.29	0.30	0.30	0.76	0.80	0.79	2.48	2.41	2.53
0.11	0.11	0.11	0.05	0.05	0.06	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.07	0.07	0.07	0.17	0.18	0.18
0.16	0.15	0.16	0.09	0.09	0.09	0.00	0.00	0.00	0.00	0.00	0.00	0.04	0.03	0.04	0.09	0.09	0.09	0.25	0.26	0.26
0.41	0.44	0.43	0.22	0.23	0.25	0.00	0.00	0.00	0.00	0.00	0.00	0.08	0.07	0.08	0.18	0.18	0.18	0.62	0.68	0.68
0.58	0.58	0.61	0.42	0.42	0.44	0.00	0.00	0.00	0.12	0.12	0.13	0.13	0.12	0.10	0.28	0.29	0.29	0.98	1.03	1.06
0.88	0.89	0.93	0.67	0.69	0.69	0.00	0.00	0.00	0.15	0.15	0.15	0.14	0.13	0.14	0.42	0.41	0.40	1.50	1.57	1.59
1.18	1.21	1.24	0.85	0.84	0.83	0.00	0.00	0.00	0.17	0.18	0.20	0.15	0.10	0.15	0.52	0.54	0.53	1.94	2.04	2.05
1.52	1.51	1.52	1.03	1.03	1.07	0.00	0.00	0.00	0.19	0.19	0.19	0.13	0.12	0.13	0.65	0.66	0.66	2.44	2.52	2.53
0.10	0.10	0.10	0.07	0.07	0.05	0.09	0.09	0.09	0.00	0.00	0.00	0.00	0.00	0.00	0.07	0.07	0.07	0.16	0.15	0.13
0.25	0.25	0.25	0.12	0.12	0.12	0.15	0.15	0.15	0.00	0.00	0.00	0.04	0.04	0.03	0.09	0.11	0.10	0.28	0.27	0.25
0.48	0.48	0.46	0.33	0.34	0.34	0.21	0.22	0.21	0.00	0.00	0.00	0.08	0.08	0.08	0.25	0.24	0.22	0.66	0.61	0.58
0.54	0.52	0.53	0.63	0.62	0.62	0.34	0.35	0.35	0.01	0.01	0.01	0.13	0.12	0.12	0.32	0.36	0.36	1.15	1.08	1.03
0.99	0.98	0.98	0.85	0.84	0.85	0.40	0.41	0.41	0.02	0.01	0.02	0.17	0.17	0.18	0.47	0.50	0.51	1.54	1.43	1.38
1.18	1.17	1.17	0.99	0.98	1.00	0.52	0.54	0.54	0.02	0.02	0.02	0.23	0.25	0.24	0.62	0.60	0.61	1.87	1.74	1.67
1.46	1.41	1.40	1.13	1.14	1.15	0.60	0.62	0.63	0.02	0.02	0.02	0.30	0.30	0.27	0.59	0.60	0.62	2.09	1.97	1.89
0.13	0.15	0.15	0.07	0.07	0.07	0.07	0.07	0.07	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.00	0.16	0.19	0.18
0.12	0.13	0.15	0.15	0.16	0.14	0.08	0.08	0.08	0.00	0.00	0.00	0.03	0.04	0.03	0.07	0.07	0.07	0.25	0.28	0.27
0.49	0.49	0.49	0.31	0.33	0.31	0.09	0.09	0.09	0.00	0.00	0.00	0.08	0.08	0.09	0.25	0.26	0.26	0.74	0.81	0.79
0.71	0.71	0.68	0.43	0.44	0.40	0.11	0.11	0.11	0.00	0.00	0.00	0.15	0.14	0.14	0.33	0.05	0.32	1.04	1.00	1.04
0.85	0.85	0.91	0.82	0.80	0.81	0.13	0.13	0.13	0.01	0.01	0.01	0.15	0.15	0.15	0.56	0.53	0.53	1.55	1.61	1.65
1.11	1.12	1.14	0.93	0.90	0.91	0.14	0.14	0.14	0.12	0.12	0.12	0.15	0.17	0.18	0.59	0.55	0.60	1.86	1.95	1.96
1.31	1.29	1.31	1.11	1.12	1.09	0.16	0.15	0.16	0.24	0.25	0.25	0.16	0.14	0.15	0.53	0.51	0.54	2.15	2.27	2.25
0.09	0.11	0.09	0.06	0.07	0.06	0.11	0.11	0.11	0.00	0.00	0.00	0.00	0.00	0.00	0.06	0.06	0.06	0.15	0.18	0.19
0.17	0.14	0.13	0.12	0.10	0.10	0.21	0.21	0.21	0.00	0.00	0.00	0.04	0.04	0.04	0.08	0.09	0.09	0.28	0.29	0.32
0.42	0.40	0.40	0.34	0.30	0.31	0.38	0.38	0.37	0.00	0.00	0.00	0.08	0.08	0.08	0.20	0.20	0.20	0.70	0.75	0.84
0.78	0.74	0.74	0.61	0.58	0.60	0.48	0.48	0.47	0.00	0.00	0.00	0.14	0.15	0.13	0.31	0.32	0.32	1.17	1.29	1.47
1.01	0.98	0.99	0.82	0.82	0.80	0.62	0.62	0.61	0.00	0.00	0.00	0.17	0.18	0.15	0.45	0.46	0.49	1.58	1.77	2.00
1.14	1.17	1.14	1.01	0.98	0.98	0.77	0.76	0.76	0.00	0.00	0.00	0.16	0.15	0.15	0.50	0.54	0.54	1.85	2.10	2.31
1.36	1.31	1.30	1.26	1.21	1.20	0.90	0.90	0.87	0.00	0.00	0.00	0.14	0.14	0.14	0.73	0.69	0.71	2.33	2.53	2.84
0.08	0.08	0.07	0.10	0.09	0.10	0.17	0.17	0.17	0.00	0.00	0.00	0.00	0.00	0.00	0.05	0.04	0.04	0.24	0.24	0.30
0.27	0.24	0.25	0.22	0.24	0.23	0.28	0.28	0.28	0.00	0.00	0.00	0.04	0.05	0.04	0.13	0.12	0.11	0.56	0.60	0.72
0.51	0.50	0.51	0.43	0.44	0.44	0.65	0.65	0.66	0.03	0.03	0.03	0.08	0.08	0.08	0.26	0.26	0.27	1.13	1.23	1.52
0.70	0.65	0.69	0.58	0.62	0.61	0.77	0.76	0.78	0.16	0.16	0.16	0.14	0.14	0.14	0.31	0.38	0.33	1.49	1.67	2.02
0.95	0.99	1.01	0.93	0.98	0.94	0.97	0.98	1.00	0.18	0.18	0.18	0.16	0.17	0.15	0.40	0.40	0.40	2.12	2.37	2.85
1.11	1.13	1.13	1.17	1.16	1.12	1.16	1.12	1.20	0.20	0.19	0.20	0.14	0.14	0.13	0.58	0.56	0.57	2.63	2.81	3.43
1.29	1.29	1.32	1.28	1.28	1.29	1.36	1.36	1.40	0.27	0.27	0.27	0.13	0.13	0.14	0.56	0.54	0.54	2.91	3.12	3.88];

i=0;
j=0;
col=colormap(hsv(8));

t={'Rc', 'Rc&Mc', 'Rc&Mh', 'Rc&Dv', 'Rc&Mc&Mh', 'Rc&Mc&Dv', 'Rc&Mh&Dv', 'Rc&Mc&Mh&Dv'};

a= [0, 4, 0, 2, -4, 0; %H2
   % 0, 2, 2, 1, -1, 1; %CO2
    0, 0, 0, 0, 1, 1; %CH4
    0, 0, 1, 0, 0, 0; %Ethanol
    2, 0, 0, -1, 0, 0; %Lactate
    0, 2, 1, 1, 0, -1; %Acetate
    2, 4, 3, 1, 1, 1]; %APT
   % -1, -1, -1, -1, 0, 0;]; %Glucose

l=size(a,1);
for c=1:8
  j=j+1;
  if c==1
      b=[a(:,1:3) zeros(l,3)];
  elseif c==2
      b=[a(:,1:3) zeros(l,2) a(:,6)];
  elseif c==3
      b=[a(:,1:3) zeros(l,1) a(:,5) zeros(l, 1)];
  elseif c==4
      b=[a(:,1:4) zeros(l,2)];
  elseif c==5
      b=[a(:,1:3) zeros(l,1) a(:,5:6)];
  elseif c==6
      b=[a(:,1:4) zeros(l,1) a(:,6)];
  elseif c==7
      b=[a(:,1:5) zeros(l,1)];
  elseif c==8
      b=[a(:,1:6)];
  end
  for rep=1:3
      for d=1:7
          i=i+1;
          p(i,:)=data(((c-1)*7+d),[1 7 10 13 16 19]+rep-1); 
          sol2(:,i) = lsqnonneg(b,p(i,:)');  
          cm(i,:)=b*sol2(1:end,i);
      end

      R(rep)=goodnessOfFit(p(7,:)',cm(7,:)','NRMSE');

      subplot(2,4,j);plot(1:7,cm(i-6:i,1),':r', 1:7,cm(i-6:i,2),':g',1:7,cm(i-6:i,3),':k',1:7,cm(i-6:i,4),'--r',1:7,cm(i-6:i,5),'--b', 1:7,cm(i-6:i,6), '--g', 'LineWidth', 2);
      hold on; 
      plot(1:7,p(i-6:i,1),'*r', 1:7,p(i-6:i,2),'*g',1:7,p(i-6:i,3),'*k',1:7,p(i-6:i,4),'or',1:7,p(i-6:i,5),'ob', 1:7,p(i-6:i,6),'og')
      
      %subplot(2,4,j);plot([1:7],sol2(1,i-6:i),':r',[1:7],sol2(2,i-6:i),':b',[1:7],sol2(3,i-6:i),':g',[1:7],sol2(4,i-6:i),':k',[1:7],sol2(5,i-6:i),'--r',[1:7],sol2(6,i-6:i),'--b','LineWidth', 2);
      %hold on;

      axis([0 6 0 3]);
      xlabel('Days'); ylabel('Flux (mmoles)'); title({t{c};['NRMSE ' num2str(round(mean(R),3)) ' +/- ' num2str(round(std(R),3))]});
     end

    if c==1
    legend({'H2', 'CH4','Ethanol','lactate','acetate','Biomass'});
  %legend({'lactate fermentation', 'hydrogenic acetogenesis', 'ethanol/acetate', 'Hydrogenic lactate oxidation','hydrogenic methanogenesis', 'acetoclastic methanogenesis'})
  
end
end
